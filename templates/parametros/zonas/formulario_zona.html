{% extends "sb_admin2/index.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado de página -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            {% if zona %}Editar{% else %}Nueva{% endif %} Zona de Reparto
        </h1>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <!-- Formulario de Zona -->
            {% include "parametros/components/formulario_parametro.html" with 
                nombre_singular="Zona"
                formulario=formulario
                objeto=zona
                url_cancelar="listar_zonas"
            %}
        </div>
        <div class="col-lg-6">
            <!-- Mapa para dibujar el polígono de la zona -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Área de la Zona</h6>
                </div>
                <div class="card-body">
                    <div id="map" style="height: 400px;"></div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="limpiarPoligono()">
                            <i class="fas fa-eraser"></i> Limpiar Área
                        </button>
                        <small class="form-text text-muted mt-2">
                            Haz clic en el mapa para dibujar el área de la zona. El último punto se conectará automáticamente con el primero.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=drawing"></script>
<script>
let map;
let drawingManager;
let polygon = null;

function initMap() {
    // Coordenadas iniciales (centro de la ciudad)
    const centro = { lat: {{ centro_lat|default:-31.4135 }}, lng: {{ centro_lng|default:-64.18105 }} };
    
    // Configurar el mapa
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: centro,
        mapTypeId: 'roadmap'
    });

    // Configurar el administrador de dibujo
    drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: google.maps.drawing.OverlayType.POLYGON,
        drawingControl: true,
        drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: ['polygon']
        },
        polygonOptions: {
            fillColor: $('#id_color').val() || '#FF0000',
            fillOpacity: 0.3,
            strokeWeight: 2,
            clickable: false,
            editable: true,
            zIndex: 1
        }
    });

    drawingManager.setMap(map);

    // Evento cuando se completa el dibujo del polígono
    google.maps.event.addListener(drawingManager, 'polygoncomplete', function(poly) {
        if (polygon) {
            polygon.setMap(null);
        }
        polygon = poly;
        actualizarCoordenadas();

        // Evento cuando se edita el polígono
        google.maps.event.addListener(polygon.getPath(), 'set_at', actualizarCoordenadas);
        google.maps.event.addListener(polygon.getPath(), 'insert_at', actualizarCoordenadas);
    });

    // Cargar polígono existente si hay coordenadas
    const coordenadasExistentes = $('#id_coordenadas').val();
    if (coordenadasExistentes) {
        try {
            const coords = JSON.parse(coordenadasExistentes);
            const paths = coords.map(coord => ({
                lat: parseFloat(coord[0]),
                lng: parseFloat(coord[1])
            }));
            
            if (polygon) {
                polygon.setMap(null);
            }
            
            polygon = new google.maps.Polygon({
                paths: paths,
                fillColor: $('#id_color').val() || '#FF0000',
                fillOpacity: 0.3,
                strokeWeight: 2,
                editable: true,
                map: map
            });

            // Ajustar el mapa al polígono
            const bounds = new google.maps.LatLngBounds();
            paths.forEach(path => bounds.extend(path));
            map.fitBounds(bounds);

            // Eventos de edición
            google.maps.event.addListener(polygon.getPath(), 'set_at', actualizarCoordenadas);
            google.maps.event.addListener(polygon.getPath(), 'insert_at', actualizarCoordenadas);
        } catch (e) {
            console.error('Error al cargar las coordenadas:', e);
        }
    }
}

function actualizarCoordenadas() {
    if (!polygon) return;

    const coords = [];
    const path = polygon.getPath();
    path.forEach(coord => {
        coords.push([coord.lat(), coord.lng()]);
    });
    $('#id_coordenadas').val(JSON.stringify(coords));
}

function limpiarPoligono() {
    if (polygon) {
        polygon.setMap(null);
        polygon = null;
        $('#id_coordenadas').val('');
    }
}

// Inicializar el mapa cuando se carga la página
$(document).ready(function() {
    initMap();

    // Actualizar color del polígono cuando cambia el selector de color
    $('#id_color').change(function() {
        if (polygon) {
            polygon.setOptions({
                fillColor: $(this).val()
            });
        }
        if (drawingManager) {
            drawingManager.setOptions({
                polygonOptions: {
                    fillColor: $(this).val(),
                    fillOpacity: 0.3,
                    strokeWeight: 2
                }
            });
        }
    });
});
</script>

<!-- Color Picker -->
<link href="{% static 'vendor/bootstrap-colorpicker/css/bootstrap-colorpicker.min.css' %}" rel="stylesheet">
<script src="{% static 'vendor/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js' %}"></script>
<script>
$(document).ready(function() {
    // Inicializar el selector de color
    $('#id_color').colorpicker({
        format: 'hex'
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
#map {
    width: 100%;
    height: 400px;
    border-radius: 0.35rem;
    border: 1px solid #e3e6f0;
}

.colorpicker-element .input-group-addon i {
    width: 16px;
    height: 16px;
}
</style>
{% endblock %} 