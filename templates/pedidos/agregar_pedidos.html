{% extends "sb_admin2/index.html" %}
{% block content %}
<h2>Agregar Pedidos al Reparto</h2>
<form method="POST" id="form-pedidos">
    {% csrf_token %}

    <!-- Selección del Reparto -->
    <div class="mb-3">
        <label for="reparto" class="form-label">Reparto:</label>
        <select id="reparto" name="reparto" class="form-control" onchange="cargarReparto()" required>
            <option value="">Seleccione un Reparto</option>
            {% for reparto in repartos %}
            <option value="{{ reparto.id }}" 
                data-chofer="{{ reparto.chofer_nombre }}"
                data-vehiculo="{{ reparto.vehiculo }}"
                data-zona="{{ reparto.zona }}"
                data-fecha="{{ reparto.fecha }}"
                {% if reparto_seleccionado == reparto.id %}selected{% endif %}>
                Reparto {{ reparto.nro_reparto }} - {{ reparto.fecha }}
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- Datos del Reparto -->
    <div id="datos-reparto" class="alert alert-info" style="display: {% if reparto_seleccionado_data %}block{% else %}none{% endif %};">
        <h5>
            <strong>Chofer:</strong> <span id="chofer">{{ reparto_seleccionado_data.chofer.nombre }}</span>
            <strong>| Vehículo:</strong> <span id="vehiculo">{{ reparto_seleccionado_data.vehiculo }}</span>
            <strong>| Zona:</strong> <span id="zona">{{ reparto_seleccionado_data.zona }}</span>
            <strong>| Fecha:</strong> <span id="fecha">{{ reparto_seleccionado_data.fecha }}</span>
        </h5>
    </div>

    <!-- Peso Total del Reparto -->
    <div id="peso-reparto-container" class="alert alert-primary mt-3" style="display: {% if reparto_seleccionado %}block{% else %}none{% endif %};">
        <h5>Peso Total del Reparto: <span id="peso-total">0.00</span> kg</h5>
    </div>

    <!-- Pedidos Existentes -->
    <div id="pedidos-existentes-container" class="mt-3" style="display: {% if pedidos_existentes %}block{% else %}none{% endif %};">
        <h5>Pedidos existentes en el reparto seleccionado:</h5>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Factura</th>
                    <th>Nombre</th>
                    <th>Calle y Número</th>
                    <th>Ciudad</th>
                    <th>Provincia</th>
                    <th>Teléfono</th>
                    <th>Email</th>
                    <th>Peso (kg)</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="pedidos-existentes-body">
                {% for pedido in pedidos_existentes %}
                <tr id="pedido-{{ pedido.id }}">
                    <td>{{ pedido.factura }}</td>
                    <td>{{ pedido.nombre }}</td>
                    <td>{{ pedido.calle_numero }}</td>
                    <td>{{ pedido.ciudad }}</td>
                    <td>{{ pedido.provincia }}</td>
                    <td>{{ pedido.telefono }}</td>
                    <td>{{ pedido.email }}</td>
                    <td class="peso-existente">{{ pedido.peso }}</td>
                    <td>{{ pedido.estado }}</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" onclick="eliminarPedido('{{ pedido.id }}')">Eliminar</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Tabla Editable para Pedidos Nuevos -->
    <div class="table-responsive mt-3">
        <table class="table table-bordered table-sm" id="tabla-pedidos">
            <thead>
                <tr>
                    <th>Código de Cliente</th>
                    <th>Nombre</th>
                    <th>Calle y Número</th>
                    <th>Ciudad</th>
                    <th>Provincia</th>
                    <th>Teléfono</th>
                    <th>Email</th>
                    <th>Factura</th>
                    <th>Peso (kg)</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tabla-pedidos-body">
                <!-- Nuevas filas dinámicas aquí -->
            </tbody>
        </table>
        <button type="button" class="btn btn-secondary mt-2" onclick="agregarFila()">Agregar Nueva Línea</button>
    </div>

    <!-- Botón para Guardar -->
    <button type="submit" class="btn btn-primary mt-3">Guardar Pedidos</button>
</form>

<script>
    function cargarReparto() {
        const repartoSelect = document.getElementById('reparto');
        const selectedOption = repartoSelect.options[repartoSelect.selectedIndex];

        if (selectedOption.value) {
            document.getElementById('chofer').innerText = selectedOption.getAttribute('data-chofer');
            document.getElementById('vehiculo').innerText = selectedOption.getAttribute('data-vehiculo');
            document.getElementById('zona').innerText = selectedOption.getAttribute('data-zona');
            document.getElementById('fecha').innerText = selectedOption.getAttribute('data-fecha');

            // Redirigir para cargar los pedidos existentes
            window.location.href = `?reparto_id=${selectedOption.value}`;
        }
    }


    function calcularPesoTotal() {
    let pesoTotal = 0;

    // Sumar pesos de pedidos existentes
    const pedidosExistentes = document.querySelectorAll('#pedidos-existentes-body .peso-existente');
    if (pedidosExistentes.length > 0) {
        pedidosExistentes.forEach(cell => {
            const peso = parseFloat(cell.textContent.trim());
            if (!isNaN(peso)) {
                pesoTotal += peso;
            } else {
                console.warn("Peso no válido en pedidos existentes:", cell.textContent);
            }
        });
    } else {
        console.warn("No se encontraron pedidos existentes.");
    }

    // Sumar pesos de pedidos nuevos
    const pedidosNuevos = document.querySelectorAll('#tabla-pedidos-body input[name^="peso_"]');
    if (pedidosNuevos.length > 0) {
        pedidosNuevos.forEach(input => {
            const peso = parseFloat(input.value.trim());
            if (!isNaN(peso)) {
                pesoTotal += peso;
            } else {
                console.warn("Peso no válido en pedidos nuevos:", input.value);
            }
        });
    } else {
        console.warn("No hay pedidos nuevos todavía.");
    }

    // Actualizar el peso total en el DOM
    document.getElementById('peso-total').innerText = pesoTotal.toFixed(2);
    }


    function agregarFila() {
        const tablaBody = document.getElementById('tabla-pedidos-body');
        const rowIndex = tablaBody.rows.length;

        const row = tablaBody.insertRow();
        row.innerHTML = `
            <td><input type="text" name="codigo_cliente_${rowIndex}" class="form-control" required></td>
            <td><input type="text" name="nombre_${rowIndex}" class="form-control" required></td>
            <td><input type="text" name="calle_numero_${rowIndex}" class="form-control" required></td>
            <td><input type="text" name="ciudad_${rowIndex}" class="form-control" required></td>
            <td><input type="text" name="provincia_${rowIndex}" class="form-control" required></td>
            <td><input type="text" name="telefono_${rowIndex}" class="form-control" required></td>
            <td><input type="email" name="email_${rowIndex}" class="form-control" required></td>
            <td><input type="text" name="factura_${rowIndex}" class="form-control" required></td>
            <td><input type="number" name="peso_${rowIndex}" class="form-control" step="0.01" required oninput="calcularPesoTotal()"></td>
            <td>
                <select name="estado_${rowIndex}" class="form-control">
                    <option value="Pendiente">Pendiente</option>
                    <option value="Confirmado">Confirmado</option>
                </select>
            </td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">Eliminar</button></td>
        `;
    }

    function eliminarFila(button) {
        const row = button.closest("tr");
        row.remove();
        calcularPesoTotal();
    }


    function eliminarPedido(pedidoId) {
    if (!confirm("¿Estás seguro de que quieres eliminar este pedido?")) {
        return;
    }

    fetch(`/eliminar_pedido/${pedidoId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCSRFToken(),
            "Content-Type": "application/json"
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`pedido-${pedidoId}`).remove();
            calcularPesoTotal();  // Actualiza el peso total
        } else {
            alert("Error al eliminar el pedido: " + data.message);
        }
    })
    .catch(error => console.error("Error al eliminar el pedido:", error));
    }

    // Obtener el token CSRF para Django
    function getCSRFToken() {
        const cookies = document.cookie.split("; ");
        for (const cookie of cookies) {
            const [name, value] = cookie.split("=");
            if (name === "csrftoken") {
                return value;
            }
        }
        return "";
    }


    document.addEventListener("DOMContentLoaded", function() {
    calcularPesoTotal();
    });

</script>
{% endblock %}
